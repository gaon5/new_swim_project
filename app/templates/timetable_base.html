{% extends "guest/layout.html" %}

{% block mycss %}
    <style>
        #navigation-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #info {
            margin: 0 20px;
        }
        .little_box:hover {
            background-color: #dbe3e8;
        }
        th {
            height: 50px;
            width: 120px;
        }
    </style>
    {% block timetable_css %}{% endblock %}
{% endblock %}

{% block body %}
    {% block timetable_body1 %}{% endblock %}
    <div class="container mt-3">
        <label for="pool_type"></label>
        <select name="pool_type" id="pool_type">
            <option value="" disabled selected>-- select a pool --</option>
            {% for pool in pool_list %}
                <option value="{{ pool[0] }}">{{ pool[1] }}</option>
            {% endfor %}
        </select>
        <label for="class_type"></label>
        <select name="class_type" id="class_type">
            <option value="" disabled selected>-- select a class type --</option>
            <option value="1">Public Lesson</option>
            <option value="2">Individual Lesson</option>
        </select>
        <label for="instructor"></label>
        <select name="instructor" id="instructor">
            <option value="" disabled selected>-- select a instructor --</option>
            {% for instructor in instructor_list %}
                <option value="{{ instructor[0] }}">{{ instructor[9] }} {{ instructor[3] }} {{ instructor[4] }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-primary my-1" onclick="reset_select()">Reset</button>
    </div>
    <div class="container mt-3">
        <div class="row" style="min-width: 960px">
            <form action="{{ url_for('display_timetable') }}" method="post" id="this_week">
                <input type="hidden" id="day" name="day">
                <div id="navigation-container">
                    <button type="button" class="mx-5 px-2" onclick="previous_week()">&larr;</button>
                    <p id="info" class="px-5">2023</p>
                    <button type="button" class="mx-5 px-2" onclick="next_week()">&rarr;</button>
                </div>
            </form>
            <table class="table table-bordered">
                <tr>
                    {% for i in range(0,8,1) %}
                        <th class="table-dark">{{ week_list[i][0] }}<br>{{ week_list[i][1] }}</th>
                    {% endfor %}
                </tr>
                {% for i in range(1,19,1) %}
                    <tr>
                        {% if i%2 == 1 %}
                            <th rowspan="2">{{ (i + 1)//2 + 9 }}:00</th>
                        {% endif %}
                        {% for j in range(1,8,1) %}
                            <th id="{{ j }}{{ i }}" class="little_box" data-bs-toggle="modal" data-bs-target="#myOwnModal" onclick="showLink({{ j }}, {{ i }})"></th>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% block timetable_body2 %}{% endblock %}

    <div class="modal fade" id="myOwnModal" tabindex="-1" aria-labelledby="myOwnModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myOwnModalLabel">{% block add_title %}{% endblock %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="pt-3 pb-3">
                        <div class="container w-75">
                            {% block myOwnModalLabel %}{% endblock %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myOwnModal2" tabindex="-1" aria-labelledby="myOwnModalLabel2" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myOwnModalLabel2">Class Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="pt-3 pb-3">
                        <div class="container w-75">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="input-group mb-3">
                                        <label for="class_name" class="input-group-text">Class name :</label>
                                        <input type="text" class="form-control" name="class_name" id="class_name" disabled>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="input-group mb-3">
                                        <label for="pool_name" class="input-group-text">Pool name :</label>
                                        <input type="text" class="form-control" name="pool_name" id="pool_name" disabled>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="input-group mb-3">
                                        <label for="instructor_name" class="input-group-text">Instructor name :</label>
                                        <input type="text" class="form-control" name="instructor_name" id="instructor_name" disabled>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="input-group mb-3">
                                        <label for="instructor_phone" class="input-group-text">Instructor phone :</label>
                                        <input type="text" class="form-control" name="instructor_phone" id="instructor_phone" disabled>
                                    </div>
                                </div>
                            </div>
                            <form action="javascript:void(0);">
                                <input type="hidden" id="class_id" name="class_id">
                                <input type="hidden" id="instructor_id" name="instructor_id">
                                <button type="submit" class="btn btn-primary my-1">View all about this class detail</button>
                            </form>
                            {% block myOwnModalLabel2 %}{% endblock %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block myjs %}
    <script>
        const currentDate = new Date("{{ today }}");
        document.getElementById('info').innerHTML = currentDate.toDateString();
        function previous_week() {
            currentDate.setDate(currentDate.getDate() - 7);
            document.getElementById('day').value = currentDate.toISOString().slice(0, 10)
            document.getElementById("this_week").submit();
        }
        function next_week() {
            currentDate.setDate(currentDate.getDate() + 7);
            document.getElementById('day').value = currentDate.toISOString().slice(0, 10)
            document.getElementById("this_week").submit();
        }

        class_list = JSON.parse('{{ all_details|tojson }}');

        function clean_table(){
            for (let w = 1; w < 8; w++) {
                    for (let e = 1; e < 19; e++){
                        let temp = String(w) + String(e)
                        const thElement = document.getElementById(temp)
                        if (thElement.style.display === 'none'){
                            thElement.removeAttribute('style');
                        }
                        thElement.setAttribute('rowspan', '1');
                        if (thElement.hasChildNodes()) {
                            const childNodes = thElement.getElementsByTagName('div');
                            for (let i = childNodes.length - 1; i >= 0; i--) {
                                const childNode = childNodes[i];
                                thElement.removeChild(childNode);
                            }
                        }
                    }
                }
        }

        function display_timetable() {
            for (const i in class_list) {
                let pool_type = Number(document.getElementById("pool_type").value)
                console.log("pool_type",pool_type,class_list[i]["pool_id"])
                if (pool_type) {
                    if (class_list[i]["pool_id"] !== pool_type) {
                        continue
                    }
                }
                let class_type = Number(document.getElementById("class_type").value)
                if (class_type) {
                    if (class_list[i]["is_individual"] !== (class_type - 1)) {
                        continue
                    }
                }
                let instructor = Number(document.getElementById("instructor").value)
                if (instructor) {
                    if (class_list[i]["instructor_id"] !== instructor) {
                        continue
                    }
                }
                let id = class_list[i]["x"] + class_list[i]["y"]
                const box = document.getElementById(id)
                const classElement = document.createElement("div");
                classElement.innerHTML = `<a href="javascript:void(0);">${class_list[i]["class_name"]}</a>`;
                classElement.setAttribute("data-bs-toggle", "modal");
                classElement.setAttribute("data-bs-target", "#myOwnModal2");
                classElement.setAttribute("onclick", "show_detail(" + i + ")");
                if (box.style.display === 'none'){
                    let id3 = class_list[i]["x"] + String(Number(class_list[i]["y"]) - 1)
                    const box3 = document.getElementById(id3)
                    box3.appendChild(classElement);
                }else{
                    box.appendChild(classElement);
                    if (class_list[i]["continuance"] > 1) {
                        box.rowSpan = class_list[i]["continuance"]
                        let id2 = class_list[i]["x"] + String(Number(class_list[i]["y"]) + 1)
                        const box2 = document.getElementById(id2)
                        box2.style.display = 'none';
                    }
                }
            }
        }

        document.getElementById('pool_type').addEventListener('change', function () {
            clean_table()
            display_timetable()
        });
        document.getElementById('class_type').addEventListener('change', function () {
            clean_table()
            display_timetable()
        });
        document.getElementById('instructor').addEventListener('change', function () {
            clean_table()
            display_timetable()
        });

        function reset_select(){
            document.getElementById('pool_type').value=""
            document.getElementById('class_type').value=""
            document.getElementById('instructor').value=""
            clean_table()
            display_timetable()
        }

        display_timetable()

        function show_detail(id) {
            event.stopPropagation();
            document.getElementById("class_name").value = class_list[id]["class_name"]
            document.getElementById("pool_name").value = class_list[id]["pool_name"]
            document.getElementById("instructor_name").value = class_list[id]["instructor_name"]
            document.getElementById("instructor_phone").value = class_list[id]["instructor_phone"]
            document.getElementById("instructor_id").value = class_list[id]["instructor_id"]
            document.getElementById("class_id").value = class_list[id]["class_id"]
        }

        function showLink(x, y) {
            console.log(x, y)
        }
    </script>
    {% block timetable_js %}{% endblock %}
{% endblock %}